name: Test Docker Build and Publish Action

on:
  workflow_dispatch:

jobs:
  test-docker-action:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Create test Dockerfiles and artifact payload
        shell: bash
        run: |
          set -euo pipefail

          # Create test directories
          mkdir -p ./.github/docker-test-{a,b,c,d,e} ./artifact-src

          # Test A: Basic image
          cat <<'EOF' > ./.github/docker-test-a/Dockerfile
          FROM alpine:3.20
          RUN echo "test image A" >/test.txt
          CMD ["cat", "/test.txt"]
          EOF

          # Test B: Image with build args
          cat <<'EOF' > ./.github/docker-test-b/Dockerfile
          FROM alpine:3.20
          ARG TEST_ARG=default
          RUN echo "test image B: ${TEST_ARG}" >/test.txt
          CMD ["cat", "/test.txt"]
          EOF

          # Test C: Multi-stage build
          cat <<'EOF' > ./.github/docker-test-c/Dockerfile
          FROM alpine:3.20 AS builder
          RUN echo "building..." > /build.txt

          FROM alpine:3.20
          COPY --from=builder /build.txt /test.txt
          RUN echo "test image C" >> /test.txt
          CMD ["cat", "/test.txt"]
          EOF

          # Test D: Image with artifact dependency
          cat <<'EOF' > ./.github/docker-test-d/Dockerfile
          FROM alpine:3.20
          COPY payload.txt /payload.txt
          RUN cat /payload.txt > /test.txt
          CMD ["cat", "/test.txt"]
          EOF

          # Test E: Image with labels
          cat <<'EOF' > ./.github/docker-test-e/Dockerfile
          FROM alpine:3.20
          LABEL maintainer="test@example.com"
          LABEL version="1.0"
          RUN echo "test image E" >/test.txt
          CMD ["cat", "/test.txt"]
          EOF

          # Create artifact payload
          echo "artifact payload for testing" > ./artifact-src/payload.txt

      - name: Upload test artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: test-artifact
          path: ./artifact-src/payload.txt

      # ============================================
      # TEST 1: Default configuration (dry-run)
      # ============================================
      - name: "Test 1: Default name, single registry (ghcr.io)"
        id: test1
        uses: Netcracker/qubership-workflow-hub/actions/docker-action@main
        with:
          registry: ghcr.io
          dry-run: "true"
          checkout: "false"
          component: |
            [{"name":"test-a","file":"./.github/docker-test-a/Dockerfile","context":"./.github/docker-test-a"}]
          platforms: linux/amd64

      - name: Validate Test 1 outputs
        shell: bash
        env:
          IMAGE_NAME: ${{ steps.test1.outputs.image-name }}
          METADATA_JSON: ${{ steps.test1.outputs.metadata-json }}
          METADATA_FILENAME: ${{ steps.test1.outputs.metadata-filename }}
        run: |
          echo "Validating Test 1 outputs..."

          # In dry-run mode, outputs should be empty
          if [ -n "$IMAGE_NAME" ] || [ -n "$METADATA_JSON" ] || [ -n "$METADATA_FILENAME" ]; then
            echo "ERROR: Expected empty outputs in dry-run mode"
            echo "  IMAGE_NAME: '$IMAGE_NAME'"
            echo "  METADATA_JSON: '$METADATA_JSON'"
            echo "  METADATA_FILENAME: '$METADATA_FILENAME'"
            exit 1
          fi

          echo "✓ Test 1 completed - Default configuration (dry-run verified)"

      # ============================================
      # TEST 2: Custom image name + dual registry
      # ============================================
      - name: "Test 2: Custom image name with dual registry (ghcr.io + docker.io)"
        id: test2
        uses: netcracker/qubership-workflow-hub/actions/docker-action@main
        with:
          registry: ghcr.io,docker.io
          dry-run: "true"
          checkout: "false"
          custom-image-name: "custom-test-image"
          component: |
            [{"name":"test-a","file":"./.github/docker-test-a/Dockerfile","context":"./.github/docker-test-a"}]
          platforms: linux/amd64
          docker-io-login: ${{ secrets.DOCKER_USERNAME || 'testuser' }}
          docker-io-token: ${{ secrets.DOCKER_TOKEN || 'testtoken' }}

      - name: Validate Test 2 outputs
        shell: bash
        env:
          IMAGE_NAME: ${{ steps.test2.outputs.image-name }}
          METADATA_JSON: ${{ steps.test2.outputs.metadata-json }}
          METADATA_FILENAME: ${{ steps.test2.outputs.metadata-filename }}
        run: |
          echo "Validating Test 2 outputs..."

          # In dry-run mode, outputs should be empty
          if [ -n "$IMAGE_NAME" ] || [ -n "$METADATA_JSON" ] || [ -n "$METADATA_FILENAME" ]; then
            echo "ERROR: Expected empty outputs in dry-run mode"
            echo "  IMAGE_NAME: '$IMAGE_NAME'"
            echo "  METADATA_JSON: '$METADATA_JSON'"
            echo "  METADATA_FILENAME: '$METADATA_FILENAME'"
            exit 1
          fi

          echo "✓ Test 2 completed - Custom image name (dry-run verified)"

      # ============================================
      # TEST 3: Download artifact + debug mode
      # ============================================
      - name: "Test 3: Artifact download with debug mode"
        id: test3
        uses: netcracker/qubership-workflow-hub/actions/docker-action@main
        with:
          registry: ghcr.io
          dry-run: "true"
          checkout: "false"
          download-artifact: "true"
          download-artifact-name: "test-artifact"
          download-artifact-path: "./.github/docker-test-d"
          download-artifact-merge-multiple: "false"
          debug: "true"
          component: |
            [{"name":"test-d","file":"./.github/docker-test-d/Dockerfile","context":"./.github/docker-test-d"}]
          platforms: linux/amd64

      - name: Validate Test 3 outputs
        shell: bash
        env:
          IMAGE_NAME: ${{ steps.test3.outputs.image-name }}
          METADATA_JSON: ${{ steps.test3.outputs.metadata-json }}
          METADATA_FILENAME: ${{ steps.test3.outputs.metadata-filename }}
        run: |
          echo "Validating Test 3 outputs..."

          # In dry-run mode, outputs should be empty
          if [ -n "$IMAGE_NAME" ] || [ -n "$METADATA_JSON" ] || [ -n "$METADATA_FILENAME" ]; then
            echo "ERROR: Expected empty outputs in dry-run mode"
            echo "  IMAGE_NAME: '$IMAGE_NAME'"
            echo "  METADATA_JSON: '$METADATA_JSON'"
            echo "  METADATA_FILENAME: '$METADATA_FILENAME'"
            exit 1
          fi

          echo "✓ Test 3 completed - Artifact download (dry-run verified)"

      # ============================================
      # TEST 4: Explicit tags
      # ============================================
      - name: "Test 4: Multiple explicit tags"
        id: test4
        uses: netcracker/qubership-workflow-hub/actions/docker-action@main
        with:
          registry: ghcr.io
          dry-run: "true"
          checkout: "false"
          tags: "v1.0.0,v1.0,latest,test-tag"
          component: |
            [{"name":"test-a","file":"./.github/docker-test-a/Dockerfile","context":"./.github/docker-test-a"}]
          platforms: linux/amd64

      - name: Validate Test 4 outputs
        shell: bash
        env:
          IMAGE_NAME: ${{ steps.test4.outputs.image-name }}
          METADATA_JSON: ${{ steps.test4.outputs.metadata-json }}
          METADATA_FILENAME: ${{ steps.test4.outputs.metadata-filename }}
        run: |
          echo "Validating Test 4 outputs..."

          # In dry-run mode, outputs should be empty
          if [ -n "$IMAGE_NAME" ] || [ -n "$METADATA_JSON" ] || [ -n "$METADATA_FILENAME" ]; then
            echo "ERROR: Expected empty outputs in dry-run mode"
            echo "  IMAGE_NAME: '$IMAGE_NAME'"
            echo "  METADATA_JSON: '$METADATA_JSON'"
            echo "  METADATA_FILENAME: '$METADATA_FILENAME'"
            exit 1
          fi

          echo "✓ Test 4 completed - Multiple tags (dry-run verified)"

      # ============================================
      # TEST 5: Build arguments
      # ============================================
      - name: "Test 5: Build arguments"
        id: test5
        uses: netcracker/qubership-workflow-hub/actions/docker-action@main
        with:
          registry: ghcr.io
          dry-run: "true"
          checkout: "false"
          build-args: |
            TEST_ARG=hello_world
          component: |
            [{"name":"test-b","file":"./.github/docker-test-b/Dockerfile","context":"./.github/docker-test-b"}]
          platforms: linux/amd64

      - name: Validate Test 5 outputs
        shell: bash
        env:
          IMAGE_NAME: ${{ steps.test5.outputs.image-name }}
          METADATA_JSON: ${{ steps.test5.outputs.metadata-json }}
          METADATA_FILENAME: ${{ steps.test5.outputs.metadata-filename }}
        run: |
          echo "Validating Test 5 outputs..."

          # In dry-run mode, outputs should be empty
          if [ -n "$IMAGE_NAME" ] || [ -n "$METADATA_JSON" ] || [ -n "$METADATA_FILENAME" ]; then
            echo "ERROR: Expected empty outputs in dry-run mode"
            echo "  IMAGE_NAME: '$IMAGE_NAME'"
            echo "  METADATA_JSON: '$METADATA_JSON'"
            echo "  METADATA_FILENAME: '$METADATA_FILENAME'"
            exit 1
          fi

          echo "✓ Test 5 completed - Build arguments (dry-run verified)"

      # ============================================
      # TEST 6: Multi-platform build
      # ============================================
      - name: "Test 6: Multi-platform build (amd64 + arm64)"
        id: test6
        uses: netcracker/qubership-workflow-hub/actions/docker-action@main
        with:
          registry: ghcr.io
          dry-run: "true"
          checkout: "false"
          component: |
            [{"name":"test-c","file":"./.github/docker-test-c/Dockerfile","context":"./.github/docker-test-c"}]
          platforms: linux/amd64,linux/arm64

      - name: Validate Test 6 outputs
        shell: bash
        env:
          IMAGE_NAME: ${{ steps.test6.outputs.image-name }}
          METADATA_JSON: ${{ steps.test6.outputs.metadata-json }}
          METADATA_FILENAME: ${{ steps.test6.outputs.metadata-filename }}
        run: |
          echo "Validating Test 6 outputs..."

          # In dry-run mode, outputs should be empty
          if [ -n "$IMAGE_NAME" ] || [ -n "$METADATA_JSON" ] || [ -n "$METADATA_FILENAME" ]; then
            echo "ERROR: Expected empty outputs in dry-run mode"
            echo "  IMAGE_NAME: '$IMAGE_NAME'"
            echo "  METADATA_JSON: '$METADATA_JSON'"
            echo "  METADATA_FILENAME: '$METADATA_FILENAME'"
            exit 1
          fi

          echo "✓ Test 6 completed - Multi-platform (dry-run verified)"

      # ============================================
      # TEST 7: SBOM generation
      # ============================================
      - name: "Test 7: SBOM generation enabled"
        id: test7
        uses: netcracker/qubership-workflow-hub/actions/docker-action@main
        with:
          registry: ghcr.io
          dry-run: "true"
          checkout: "false"
          sbom: "true"
          component: |
            [{"name":"test-a","file":"./.github/docker-test-a/Dockerfile","context":"./.github/docker-test-a"}]
          platforms: linux/amd64

      - name: Validate Test 7 outputs
        shell: bash
        env:
          IMAGE_NAME: ${{ steps.test7.outputs.image-name }}
          METADATA_JSON: ${{ steps.test7.outputs.metadata-json }}
          METADATA_FILENAME: ${{ steps.test7.outputs.metadata-filename }}
        run: |
          echo "Validating Test 7 outputs..."

          # In dry-run mode, outputs should be empty
          if [ -n "$IMAGE_NAME" ] || [ -n "$METADATA_JSON" ] || [ -n "$METADATA_FILENAME" ]; then
            echo "ERROR: Expected empty outputs in dry-run mode"
            echo "  IMAGE_NAME: '$IMAGE_NAME'"
            echo "  METADATA_JSON: '$METADATA_JSON'"
            echo "  METADATA_FILENAME: '$METADATA_FILENAME'"
            exit 1
          fi

          echo "✓ Test 7 completed - SBOM generation (dry-run verified)"

      # ============================================
      # TEST 8: Component with build args in JSON
      # ============================================
      - name: "Test 8: Component with inline build arguments"
        id: test8
        uses: netcracker/qubership-workflow-hub/actions/docker-action@main
        with:
          registry: ghcr.io
          dry-run: "true"
          checkout: "false"
          component: |
            [{
              "name":"test-b",
              "file":"./.github/docker-test-b/Dockerfile",
              "context":"./.github/docker-test-b",
              "arguments":"TEST_ARG=from_component_json"
            }]
          platforms: linux/amd64

      - name: Validate Test 8 outputs
        shell: bash
        env:
          IMAGE_NAME: ${{ steps.test8.outputs.image-name }}
          METADATA_JSON: ${{ steps.test8.outputs.metadata-json }}
          METADATA_FILENAME: ${{ steps.test8.outputs.metadata-filename }}
        run: |
          echo "Validating Test 8 outputs..."

          # In dry-run mode, outputs should be empty
          if [ -n "$IMAGE_NAME" ] || [ -n "$METADATA_JSON" ] || [ -n "$METADATA_FILENAME" ]; then
            echo "ERROR: Expected empty outputs in dry-run mode"
            echo "  IMAGE_NAME: '$IMAGE_NAME'"
            echo "  METADATA_JSON: '$METADATA_JSON'"
            echo "  METADATA_FILENAME: '$METADATA_FILENAME'"
            exit 1
          fi

          echo "✓ Test 8 completed - Component build args (dry-run verified)"

      # ============================================
      # TEST 9: Skip QEMU and Buildx setup
      # ============================================
      - name: "Test 9: Custom Buildx configuration"
        id: test9
        uses: netcracker/qubership-workflow-hub/actions/docker-action@main
        with:
          registry: ghcr.io
          dry-run: "true"
          checkout: "false"
          setup-qemu: "false"
          setup-buildx: "false"
          component: |
            [{"name":"test-e","file":"./.github/docker-test-e/Dockerfile","context":"./.github/docker-test-e"}]
          platforms: linux/amd64

      - name: Validate Test 9 outputs
        shell: bash
        env:
          IMAGE_NAME: ${{ steps.test9.outputs.image-name }}
          METADATA_JSON: ${{ steps.test9.outputs.metadata-json }}
          METADATA_FILENAME: ${{ steps.test9.outputs.metadata-filename }}
        run: |
          echo "Validating Test 9 outputs..."

          # In dry-run mode, outputs should be empty
          if [ -n "$IMAGE_NAME" ] || [ -n "$METADATA_JSON" ] || [ -n "$METADATA_FILENAME" ]; then
            echo "ERROR: Expected empty outputs in dry-run mode"
            echo "  IMAGE_NAME: '$IMAGE_NAME'"
            echo "  METADATA_JSON: '$METADATA_JSON'"
            echo "  METADATA_FILENAME: '$METADATA_FILENAME'"
            exit 1
          fi

          echo "✓ Test 9 completed - Custom Buildx config (dry-run verified)"

      # ============================================
      # TEST 10: Default component (no name override)
      # ============================================
      - name: "Test 10: Default component name"
        id: test10
        uses: netcracker/qubership-workflow-hub/actions/docker-action@main
        with:
          registry: ghcr.io
          dry-run: "true"
          checkout: "false"
          component: |
            [{"name":"default","file":"./.github/docker-test-a/Dockerfile","context":"./.github/docker-test-a"}]
          platforms: linux/amd64

      - name: Validate Test 10 outputs
        shell: bash
        env:
          IMAGE_NAME: ${{ steps.test10.outputs.image-name }}
          METADATA_JSON: ${{ steps.test10.outputs.metadata-json }}
          METADATA_FILENAME: ${{ steps.test10.outputs.metadata-filename }}
        run: |
          echo "Validating Test 10 outputs..."

          # In dry-run mode, outputs should be empty
          if [ -n "$IMAGE_NAME" ] || [ -n "$METADATA_JSON" ] || [ -n "$METADATA_FILENAME" ]; then
            echo "ERROR: Expected empty outputs in dry-run mode"
            echo "  IMAGE_NAME: '$IMAGE_NAME'"
            echo "  METADATA_JSON: '$METADATA_JSON'"
            echo "  METADATA_FILENAME: '$METADATA_FILENAME'"
            exit 1
          fi

          echo "✓ Test 10 completed - Default component (dry-run verified)"

      # ============================================
      # TEST 11: Verify build process (dry-run but check build succeeded)
      # ============================================
      - name: "Test 11: Verify complete build process without push"
        id: test11
        uses: netcracker/qubership-workflow-hub/actions/docker-action@main
        with:
          registry: ghcr.io
          dry-run: "true"
          checkout: "false"
          component: |
            [{"name":"test-build-verification","file":"./.github/docker-test-c/Dockerfile","context":"./.github/docker-test-c"}]
          platforms: linux/amd64

      - name: Validate Test 11 (build process verification)
        shell: bash
        env:
          IMAGE_NAME: ${{ steps.test11.outputs.image-name }}
          METADATA_JSON: ${{ steps.test11.outputs.metadata-json }}
          METADATA_FILENAME: ${{ steps.test11.outputs.metadata-filename }}
        run: |
          echo "Validating Test 11 - build process verification..."

          # In dry-run mode, outputs should be empty
          if [ -n "$IMAGE_NAME" ] || [ -n "$METADATA_JSON" ] || [ -n "$METADATA_FILENAME" ]; then
            echo "ERROR: Expected empty outputs in dry-run mode"
            echo "  IMAGE_NAME: '$IMAGE_NAME'"
            echo "  METADATA_JSON: '$METADATA_JSON'"
            echo "  METADATA_FILENAME: '$METADATA_FILENAME'"
            exit 1
          fi

          # If we reached here, the build succeeded (docker build-push-action didn't fail)
          echo "✓ Test 11 completed - Build process verified (dry-run, no push)"

      # ============================================
      # FINAL VALIDATION
      # ============================================
      - name: Final validation summary
        shell: bash
        run: |
          echo "=========================================="
          echo "   All Tests Passed Successfully ✓"
          echo "=========================================="
          echo ""
          echo "Tests completed:"
          echo "  ✓ Test 1:  Default configuration (dry-run)"
          echo "  ✓ Test 2:  Custom image name + dual registry (dry-run)"
          echo "  ✓ Test 3:  Artifact download + debug (dry-run)"
          echo "  ✓ Test 4:  Multiple explicit tags (dry-run)"
          echo "  ✓ Test 5:  Build arguments (dry-run)"
          echo "  ✓ Test 6:  Multi-platform build (dry-run)"
          echo "  ✓ Test 7:  SBOM generation (dry-run)"
          echo "  ✓ Test 8:  Component build args (dry-run)"
          echo "  ✓ Test 9:  Custom Buildx config (dry-run)"
          echo "  ✓ Test 10: Default component name (dry-run)"
          echo "  ✓ Test 11: Build process verification (dry-run)"
          echo ""
          echo "All validations passed:"
          echo "  ✓ Input parsing and validation"
          echo "  ✓ Registry configuration"
          echo "  ✓ Component JSON parsing"
          echo "  ✓ Image name generation"
          echo "  ✓ Tag handling (auto and explicit)"
          echo "  ✓ Build arguments (inline and component)"
          echo "  ✓ Multi-platform builds"
          echo "  ✓ Artifact downloading"
          echo "  ✓ SBOM generation"
          echo "  ✓ QEMU/Buildx configuration"
          echo "  ✓ Dry-run output validation"
