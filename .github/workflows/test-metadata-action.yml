name: Test metadata-action

on:
  workflow_dispatch: {}

jobs:
  test-default-template:
    name: Test Default Template
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Run Metadata Action
        id: metadata
        uses: ./actions/metadata-action
        with:
          show-report: "true"

      - name: Verify Outputs
        shell: bash
        run: |
          echo "=== Outputs ==="
          RESULT="${{ steps.metadata.outputs.result }}"
          REF="${{ steps.metadata.outputs.ref }}"
          REF_NAME="${{ steps.metadata.outputs.ref-name }}"
          DATE="${{ steps.metadata.outputs.date }}"
          TIME="${{ steps.metadata.outputs.time }}"
          TIMESTAMP="${{ steps.metadata.outputs.timestamp }}"
          DIST_TAG="${{ steps.metadata.outputs.dist-tag }}"
          SHORT_SHA="${{ steps.metadata.outputs.short-sha }}"
          RUN_NUMBER="${{ github.run_number }}"

          echo "result: $RESULT"
          echo "ref: $REF"
          echo "ref-name: $REF_NAME"
          echo "date: $DATE"
          echo "time: $TIME"
          echo "timestamp: $TIMESTAMP"
          echo "dist-tag: $DIST_TAG"
          echo "short-sha: $SHORT_SHA"

          # Verify result matches default template: {{ref-name}}-{{timestamp}}-{{runNumber}}
          EXPECTED_RESULT="${REF_NAME}-${TIMESTAMP}-${RUN_NUMBER}"
          if [ "$RESULT" != "$EXPECTED_RESULT" ]; then
            echo "❌ ERROR: result doesn't match default template"
            echo "   Expected: $EXPECTED_RESULT"
            echo "   Got: $RESULT"
            exit 1
          fi

          # Verify ref is normalized (without "refs/" prefix)
          if [[ "$REF" == refs/* ]]; then
            echo "❌ ERROR: ref should be normalized (without 'refs/' prefix), got: $REF"
            exit 1
          fi

          # Verify date format (YYYYMMDD)
          if ! [[ "$DATE" =~ ^[0-9]{8}$ ]]; then
            echo "❌ ERROR: date format is invalid, expected YYYYMMDD, got: $DATE"
            exit 1
          fi

          # Verify time format (HHMMSS)
          if ! [[ "$TIME" =~ ^[0-9]{6}$ ]]; then
            echo "❌ ERROR: time format is invalid, expected HHMMSS, got: $TIME"
            exit 1
          fi

          # Verify timestamp format (YYYYMMDDHHMMSS)
          if ! [[ "$TIMESTAMP" =~ ^[0-9]{14}$ ]]; then
            echo "❌ ERROR: timestamp format is invalid, expected YYYYMMDDHHMMSS, got: $TIMESTAMP"
            exit 1
          fi

          # Verify short-sha length (default is 7)
          if [ ${#SHORT_SHA} -ne 7 ]; then
            echo "❌ ERROR: short-sha length should be 7, got: ${#SHORT_SHA}"
            exit 1
          fi

          # Verify default dist-tag
          if [ "$DIST_TAG" != "latest" ]; then
            echo "❌ ERROR: default dist-tag should be 'latest', got: $DIST_TAG"
            exit 1
          fi

          echo "✅ Default template test passed!"

  test-custom-template:
    name: Test Custom Template
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Run Metadata Action
        id: metadata
        uses: ./actions/metadata-action
        with:
          default-template: "v{{major}}.{{minor}}.{{patch}}-{{ref-name}}-{{date}}-{{short-sha}}"
          default-tag: "custom-tag"
          short-sha: "10"
          replace-symbol: "_"
          show-report: "true"

      - name: Verify Outputs
        shell: bash
        run: |
          echo "=== Outputs ==="
          RESULT="${{ steps.metadata.outputs.result }}"
          REF_NAME="${{ steps.metadata.outputs.ref-name }}"
          DATE="${{ steps.metadata.outputs.date }}"
          DIST_TAG="${{ steps.metadata.outputs.dist-tag }}"
          SHORT_SHA="${{ steps.metadata.outputs.short-sha }}"
          MAJOR="${{ steps.metadata.outputs.major }}"
          MINOR="${{ steps.metadata.outputs.minor }}"
          PATCH="${{ steps.metadata.outputs.patch }}"

          echo "result: $RESULT"
          echo "ref-name: $REF_NAME"
          echo "date: $DATE"
          echo "dist-tag: $DIST_TAG"
          echo "short-sha: $SHORT_SHA"
          echo "major: $MAJOR"
          echo "minor: $MINOR"
          echo "patch: $PATCH"

          # Verify result matches custom template: v{{major}}.{{minor}}.{{patch}}-{{ref-name}}-{{date}}-{{short-sha}}
          EXPECTED_RESULT="v${MAJOR}.${MINOR}.${PATCH}-${REF_NAME}-${DATE}-${SHORT_SHA}"
          if [ "$RESULT" != "$EXPECTED_RESULT" ]; then
            echo "❌ ERROR: result doesn't match custom template"
            echo "   Expected: $EXPECTED_RESULT"
            echo "   Got: $RESULT"
            exit 1
          fi

          # Verify custom dist-tag
          if [ "$DIST_TAG" != "custom-tag" ]; then
            echo "❌ ERROR: dist-tag should be 'custom-tag', got: $DIST_TAG"
            exit 1
          fi

          # Verify short-sha length (set to 10)
          if [ ${#SHORT_SHA} -ne 10 ]; then
            echo "❌ ERROR: short-sha length should be 10, got: ${#SHORT_SHA}"
            exit 1
          fi

          # Verify ref-name doesn't contain '/' (should be replaced with '_')
          if [[ "$REF_NAME" == *"/"* ]]; then
            echo "❌ ERROR: ref-name should not contain '/', replace symbol should be applied"
            exit 1
          fi

          echo "✅ Custom template test passed!"

  test-github-context:
    name: Test GitHub Context Variables
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Run Metadata Action with GitHub Context
        id: metadata
        uses: ./actions/metadata-action
        with:
          default-template: "build-{{github.context.workflow}}-run{{github.context.runNumber}}-by-{{github.context.actor}}"
          default-tag: "context-tag"
          show-report: "true"

      - name: Display GitHub Context Values
        shell: bash
        run: |
          echo "=== Available GitHub Context Values ==="
          echo "workflow: ${{ github.workflow }}"
          echo "actor: ${{ github.actor }}"
          echo "event_name: ${{ github.event_name }}"
          echo "repository: ${{ github.repository }}"
          echo "ref: ${{ github.ref }}"
          echo "sha: ${{ github.sha }}"
          echo "run_number: ${{ github.run_number }}"
          echo "run_id: ${{ github.run_id }}"
          echo "job: ${{ github.job }}"

      - name: Verify GitHub Context Outputs
        shell: bash
        run: |
          echo "=== Action Output ==="
          RESULT="${{ steps.metadata.outputs.result }}"

          echo "result: $RESULT"

          # Verify that placeholders were replaced (should NOT contain {{}})
          if [[ "$RESULT" == *"{{"* ]] || [[ "$RESULT" == *"}}"* ]]; then
            echo "❌ ERROR: result still contains template placeholders, GitHub context not processed"
            echo "   Got: $RESULT"
            exit 1
          fi

          # Verify result starts with "build-" prefix
          if [[ ! "$RESULT" == build-* ]]; then
            echo "❌ ERROR: result should start with 'build-'"
            echo "   Got: $RESULT"
            exit 1
          fi

          # Verify result contains expected patterns
          if [[ ! "$RESULT" =~ -run[0-9]+-by- ]]; then
            echo "❌ ERROR: result should match pattern 'build-{workflow}-run{number}-by-{actor}'"
            echo "   Got: $RESULT"
            exit 1
          fi

          # Verify result contains the workflow name (with spaces replaced by dashes or underscores)
          WORKFLOW_NORMALIZED="${{ github.workflow }}"
          WORKFLOW_NORMALIZED="${WORKFLOW_NORMALIZED// /-}"  # Replace spaces with dashes

          if [[ ! "$RESULT" == *"$WORKFLOW_NORMALIZED"* ]] && [[ ! "$RESULT" == *"Test metadata-action"* ]]; then
            echo "⚠️  WARNING: result might not contain workflow name, got: $RESULT"
          fi

          echo "✅ GitHub context variables successfully interpolated into template"
          echo "✅ GitHub context test passed!"
