name: Test metadata-action

on:
  workflow_dispatch: {}

jobs:
  test-default-template:
    name: Test Default Template
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Run Metadata Action
        id: metadata
        uses: ./actions/metadata-action
        with:
          show-report: "true"

      - name: Verify Outputs
        shell: bash
        run: |
          echo "=== Outputs ==="
          RESULT="${{ steps.metadata.outputs.result }}"
          REF="${{ steps.metadata.outputs.ref }}"
          REF_NAME="${{ steps.metadata.outputs.ref-name }}"
          DATE="${{ steps.metadata.outputs.date }}"
          TIME="${{ steps.metadata.outputs.time }}"
          TIMESTAMP="${{ steps.metadata.outputs.timestamp }}"
          DIST_TAG="${{ steps.metadata.outputs.dist-tag }}"
          SHORT_SHA="${{ steps.metadata.outputs.short-sha }}"
          RUN_NUMBER="${{ github.run_number }}"

          echo "result: $RESULT"
          echo "ref: $REF"
          echo "ref-name: $REF_NAME"
          echo "date: $DATE"
          echo "time: $TIME"
          echo "timestamp: $TIMESTAMP"
          echo "dist-tag: $DIST_TAG"
          echo "short-sha: $SHORT_SHA"

          # Verify result matches default template: {{ref-name}}-{{timestamp}}-{{runNumber}}
          EXPECTED_RESULT="${REF_NAME}-${TIMESTAMP}-${RUN_NUMBER}"
          if [ "$RESULT" != "$EXPECTED_RESULT" ]; then
            echo "❌ ERROR: result doesn't match default template"
            echo "   Expected: $EXPECTED_RESULT"
            echo "   Got: $RESULT"
            exit 1
          fi

          # Verify ref is normalized (without "refs/" prefix)
          if [[ "$REF" == refs/* ]]; then
            echo "❌ ERROR: ref should be normalized (without 'refs/' prefix), got: $REF"
            exit 1
          fi

          # Verify date format (YYYYMMDD)
          if ! [[ "$DATE" =~ ^[0-9]{8}$ ]]; then
            echo "❌ ERROR: date format is invalid, expected YYYYMMDD, got: $DATE"
            exit 1
          fi

          # Verify time format (HHMMSS)
          if ! [[ "$TIME" =~ ^[0-9]{6}$ ]]; then
            echo "❌ ERROR: time format is invalid, expected HHMMSS, got: $TIME"
            exit 1
          fi

          # Verify timestamp format (YYYYMMDDHHMMSS)
          if ! [[ "$TIMESTAMP" =~ ^[0-9]{14}$ ]]; then
            echo "❌ ERROR: timestamp format is invalid, expected YYYYMMDDHHMMSS, got: $TIMESTAMP"
            exit 1
          fi

          # Verify short-sha length (default is 7)
          if [ ${#SHORT_SHA} -ne 7 ]; then
            echo "❌ ERROR: short-sha length should be 7, got: ${#SHORT_SHA}"
            exit 1
          fi

          # Verify default dist-tag
          if [ "$DIST_TAG" != "latest" ]; then
            echo "❌ ERROR: default dist-tag should be 'latest', got: $DIST_TAG"
            exit 1
          fi

          echo "✅ Default template test passed!"

  test-custom-template:
    name: Test Custom Template
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Run Metadata Action
        id: metadata
        uses: ./actions/metadata-action
        with:
          default-template: "v{{major}}.{{minor}}.{{patch}}-{{ref-name}}-{{date}}-{{short-sha}}"
          default-tag: "custom-tag"
          short-sha: "10"
          replace-symbol: "_"
          show-report: "true"

      - name: Verify Outputs
        shell: bash
        run: |
          echo "=== Outputs ==="
          RESULT="${{ steps.metadata.outputs.result }}"
          REF_NAME="${{ steps.metadata.outputs.ref-name }}"
          DATE="${{ steps.metadata.outputs.date }}"
          DIST_TAG="${{ steps.metadata.outputs.dist-tag }}"
          SHORT_SHA="${{ steps.metadata.outputs.short-sha }}"
          MAJOR="${{ steps.metadata.outputs.major }}"
          MINOR="${{ steps.metadata.outputs.minor }}"
          PATCH="${{ steps.metadata.outputs.patch }}"

          echo "result: $RESULT"
          echo "ref-name: $REF_NAME"
          echo "date: $DATE"
          echo "dist-tag: $DIST_TAG"
          echo "short-sha: $SHORT_SHA"
          echo "major: $MAJOR"
          echo "minor: $MINOR"
          echo "patch: $PATCH"

          # Verify result matches custom template: v{{major}}.{{minor}}.{{patch}}-{{ref-name}}-{{date}}-{{short-sha}}
          EXPECTED_RESULT="v${MAJOR}.${MINOR}.${PATCH}-${REF_NAME}-${DATE}-${SHORT_SHA}"
          if [ "$RESULT" != "$EXPECTED_RESULT" ]; then
            echo "❌ ERROR: result doesn't match custom template"
            echo "   Expected: $EXPECTED_RESULT"
            echo "   Got: $RESULT"
            exit 1
          fi

          # Verify custom dist-tag
          if [ "$DIST_TAG" != "custom-tag" ]; then
            echo "❌ ERROR: dist-tag should be 'custom-tag', got: $DIST_TAG"
            exit 1
          fi

          # Verify short-sha length (set to 10)
          if [ ${#SHORT_SHA} -ne 10 ]; then
            echo "❌ ERROR: short-sha length should be 10, got: ${#SHORT_SHA}"
            exit 1
          fi

          # Verify ref-name doesn't contain '/' (should be replaced with '_')
          if [[ "$REF_NAME" == *"/"* ]]; then
            echo "❌ ERROR: ref-name should not contain '/', replace symbol should be applied"
            exit 1
          fi

          echo "✅ Custom template test passed!"

  test-github-context:
    name: Test GitHub Context Variables
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Run Metadata Action with GitHub Context
        id: metadata
        uses: ./actions/metadata-action
        with:
          default-template: "{{github.workflow}}-{{github.runNumber}}-{{github.actor}}-{{github.eventName}}"
          default-tag: "context-tag"
          show-report: "true"

      - name: Verify GitHub Context Outputs
        shell: bash
        run: |
          echo "=== Outputs ==="
          RESULT="${{ steps.metadata.outputs.result }}"
          WORKFLOW="${{ github.workflow }}"
          RUN_NUMBER="${{ github.run_number }}"
          ACTOR="${{ github.actor }}"
          EVENT_NAME="${{ github.event_name }}"

          echo "result: $RESULT"
          echo "workflow: $WORKFLOW"
          echo "run_number: $RUN_NUMBER"
          echo "actor: $ACTOR"
          echo "event_name: $EVENT_NAME"

          # Verify result matches GitHub context template
          EXPECTED_RESULT="${WORKFLOW}-${RUN_NUMBER}-${ACTOR}-${EVENT_NAME}"
          if [ "$RESULT" != "$EXPECTED_RESULT" ]; then
            echo "❌ ERROR: result doesn't match GitHub context template"
            echo "   Expected: $EXPECTED_RESULT"
            echo "   Got: $RESULT"
            exit 1
          fi

          # Verify workflow name
          if [ -z "$WORKFLOW" ]; then
            echo "❌ ERROR: workflow name should not be empty"
            exit 1
          fi

          # Verify run number is a positive integer
          if ! [[ "$RUN_NUMBER" =~ ^[0-9]+$ ]]; then
            echo "❌ ERROR: run_number should be a positive integer, got: $RUN_NUMBER"
            exit 1
          fi

          # Verify event name (should be workflow_dispatch for this test)
          if [ "$EVENT_NAME" != "workflow_dispatch" ]; then
            echo "⚠️  WARNING: expected event_name to be 'workflow_dispatch', got: $EVENT_NAME"
          fi

          echo "✅ GitHub context test passed!"
